apiVersion: apps/v1
kind: Deployment
metadata:
  name: salt-master
  namespace: aria-config
spec:
  replicas: 1
  selector: { matchLabels: { app: salt-master } }
  template:
    metadata:
      labels: { app: salt-master }
        annotations:
          container.apparmor.security.beta.kubernetes.io/salt-master: runtime/default
    spec:
      securityContext:
        seccompProfile: { type: RuntimeDefault }
      containers:
        - name: salt-master
          image: docker.io/saltstack/salt:3007
          command: ["/usr/bin/dumb-init", "--"]
          args: ["salt-master", "-l", "info"]
          ports:
            - containerPort: 4505
            - containerPort: 4506
          securityContext:
            runAsNonRoot: true
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities: { drop: ["ALL"] }
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 1
              memory: 1Gi
          volumeMounts:
            - name: etc-salt
              mountPath: /etc/salt
            - name: srv-salt
              mountPath: /srv/salt
            - name: cache
              mountPath: /var/cache/salt
            - name: logs
              mountPath: /var/log/salt
            - name: run
              mountPath: /var/run/salt
            - name: minion-artifacts
              mountPath: /etc/salt/deployment.d
              subPath: deployment.d
            - name: minion-artifacts
              mountPath: /etc/salt/cloud.deploy.d
              subPath: cloud.deploy.d
            - name: minion-artifacts
              mountPath: /etc/salt/cloud.profiles.d
              subPath: cloud.profiles.d
          readinessProbe:
            tcpSocket: { port: 4506 }
            initialDelaySeconds: 10
            periodSeconds: 10
          livenessProbe:
            tcpSocket: { port: 4505 }
            initialDelaySeconds: 20
            periodSeconds: 20
        volumes:
          - name: etc-salt
            persistentVolumeClaim:
              claimName: salt-master-pvc
          - name: srv-salt
            persistentVolumeClaim: 
              claimName: salt-master-pvc
          - name: cache
            emptyDir: {}
          - name: logs
            emptyDir: {}
          - name: run
            emptyDir: {}
          - name: minion-artifacts
            persistentVolumeClaim:
              claimName: salt-minion-artifacts-pvc
      initContainers:
        - name: seed-minion-artifacts
          image: registry.example.com/ssc/minion-artifacts:1.0   # <â€” override via kustomize
          command: ["/bin/sh","-c"]
          args:
            - |
              set -e
              mkdir -p /out/deployment.d /out/cloud.deploy.d /out/cloud.profiles.d
              cp -a /payload/deployment.d/* /out/deployment.d/ 2>/dev/null || true
              cp -a /payload/cloud.deploy.d/* /out/cloud.deploy.d/ 2>/dev/null || true
              cp -a /payload/cloud.profiles.d/* /out/cloud.profiles.d/ 2>/dev/null || true
          securityContext:
            runAsNonRoot: true
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities: { drop: ["ALL"] }
          volumeMounts:
            - name: minion-artifacts
              mountPath: /out